<!-- Version of 02-09-2016 -->
<graph id="Graph">
  <version>1.0</version>
  <node id="Read">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$filein</file>
    </parameters>
  </node>
  <node id="SeaMask">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$maskin</file>
	  <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  <node id="Reproject">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="Read"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>22.30</easting>
      <northing>41.20</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>470</width>
      <height>540</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="Reproject_SM">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="SeaMask"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>22.30</easting>
      <northing>41.20</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>470</width>
      <height>540</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node><node id="BandMaths">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="Reproject"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
		<targetBand>
          <name>flagged_Chl</name>
          <expression>if QI &lt; -1.9 or QI &gt; 1.9 then 1 else 0</expression>
          <description>Flagged Chl</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
<!-- FLAGGING
quality_level  between 0 (bad) and 5 (good)
-->
  <node id="BandMaths_b">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="BandMaths"/>
	  <sourceProduct2 refid="Reproject"/>
	  <sourceProduct3 refid="Reproject_SM"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
        <targetBand>
          <name>Chlorophyll</name>
          <type>float32</type>
          <expression>if ($sourceProduct3.band_1) == 0 then -10 else (if (flagged_Chl >0) then -11.0 else $sourceProduct2.CHL)</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="Write">
    <operator>Write</operator>
    <sources>
      <sourceProduct refid="BandMaths_b"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$fileout</file>
      <formatName>$format</formatName>
    </parameters>
  </node>
</graph>