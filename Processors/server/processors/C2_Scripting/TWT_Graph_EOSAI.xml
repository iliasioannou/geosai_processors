<!-- Version of 14-10-2016 -->
<graph id="Graph">
  <version>1.0</version>
  <node id="SeaMask">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$maskin</file>
	  <formatName>GeoTIFF</formatName>
    </parameters>
  </node>
  <node id="Read490">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$filein490</file>
	  <!--<formatName>NetCDF</formatName>-->
    </parameters>
  </node>
  <node id="Read555">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$filein555</file>
    </parameters>
  </node>
  <node id="Read678">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$filein670</file>
    </parameters>
  </node>
  <node id="ReadKD490">
    <operator>Read</operator>
    <sources/>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$fileinKd</file>
    </parameters>
  </node>
  <node id="Reproject490">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="Read490"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>19.38</easting>
      <northing>39.87</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>250</width>
      <height>202</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="Reproject555">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="Read555"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>19.38</easting>
      <northing>39.87</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>250</width>
      <height>202</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="Reproject678">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="Read678"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>12.00</easting>
      <northing>45.83</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>745</width>
      <height>643</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="ReprojectKD490">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="ReadKD490"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>12.00</easting>
      <northing>45.83</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>745</width>
      <height>643</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="Reproject_seamask">
    <operator>Reproject</operator>
    <sources>
      <sourceProduct refid="SeaMask"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <wktFile/>
      <crs>EPSG:4326</crs>
      <resampling>Nearest</resampling>
      <referencePixelX>0.5</referencePixelX>
      <referencePixelY>0.5</referencePixelY>
      <easting>12.00</easting>
      <northing>45.83</northing>
      <orientation>0.0</orientation>
      <pixelSizeX>0.01</pixelSizeX>
      <pixelSizeY>0.01</pixelSizeY>
      <width>745</width>
      <height>643</height>
      <tileSizeX/>
      <tileSizeY/>
      <orthorectify>false</orthorectify>
      <elevationModelName/>
      <noDataValue/>
      <includeTiePointGrids>true</includeTiePointGrids>
      <addDeltaBands>false</addDeltaBands>
    </parameters>
  </node>
  <node id="BandMerge">
    <operator>BandMerge</operator>
    <sources>
      <sourceProduct refid="Reproject490"/>
      <sourceProduct.1 refid="Reproject555"/>
      <sourceProduct.2 refid="Reproject678"/>
	  <sourceProduct.3 refid="ReprojectKD490"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <sourceBands/>
      <geographicError>1.0E-5</geographicError>
    </parameters>
  </node>
  <node id="Single_QI">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="Reproject490"/>
      <sourceProduct1 refid="Reproject555"/>
      <sourceProduct2 refid="Reproject678"/>
	  <sourceProduct3 refid="ReprojectKD490"/>
    </sources>>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
	  <targetBand>
          <name>QI_nrrs490</name>
          <expression>if QI &lt; -1.9 or QI &gt; 1.9 then 1 else 0</expression>
          <description>rss490nm low quality pixels</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	  <targetBand>
          <name>QI_nrrs555</name>
          <expression>if $sourceProduct1.QI &lt; -1.9 or $sourceProduct1.QI &gt; 1.9 then 1 else 0</expression>
          <description>rss555nm low quality pixels</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	  <targetBand>
          <name>QI_nrrs678</name>
          <expression>if $sourceProduct2.QI &lt; -1.9 or $sourceProduct2.QI &gt; 1.9 then 1 else 0</expression>
          <description>rss678nm low quality pixels</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	  <targetBand>
          <name>QI_KD490</name>
          <expression>if $sourceProduct3.QI &lt; -1.9 or $sourceProduct3.QI &gt; 1.9 then 1 else 0</expression>
          <description>KD490 low quality pixels</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>  
  <node id="WFlaggedPix">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="Single_QI"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
	    <targetBand>
          <name>flagged_band</name>
          <expression>if (QI_nrrs490+QI_nrrs555+QI_nrrs678+QI_KD490) &gt;= 1 then 1 else 0</expression>
          <description>Flagged pixels</description>
          <type>int16</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="Rename_Flag">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="BandMerge"/>
	  <sourceProduct2 refid="WFlaggedPix"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
	    <targetBand>
          <name>Rrs_488</name>
          <expression>if ($sourceProduct2.flagged_band == 0) then RRS490 else NaN</expression>
          <description>Flagged 490</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	    <targetBand>
          <name>Rrs_555</name>
          <expression>if ($sourceProduct2.flagged_band == 0) then RRS555 else NaN</expression>
          <description>Flagged 555</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	    <targetBand>
          <name>Rrs_678</name>
          <expression>if ($sourceProduct2.flagged_band == 0) then RRS670 else NaN</expression>
          <description>Flagged 678</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
	    <targetBand>
          <name>Kd_490</name>
          <expression>if ($sourceProduct2.flagged_band == 0) then KD490 else NaN</expression>
          <description>Flagged KD490</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="PreCalc">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="Rename_Flag"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
        <targetBand>
          <name>Turbidity_base</name>
          <expression>((292.51*Rrs_678*PI)/(1-(Rrs_678*PI)/0.1774))+0.11+0.8</expression>
          <description>Turbidity by Nechad et al. 2009. Plus correction factor</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
        <targetBand>
          <name>mrrs_490</name>
          <expression>if ((Rrs_488 >0) or (Rrs_555>0)) then Rrs_488/(0.52+1.7*Rrs_488) else NaN</expression>
          <description/>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
        <targetBand>
          <name>mrrs_560</name>
          <expression>if ((Rrs_488 >0) or (Rrs_555>0)) then Rrs_555/(0.52+1.7*Rrs_555) else NaN</expression>
          <description/>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="BandMaths(2)">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="PreCalc"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
	     <targetBand>
          <name>Turbidity</name>
          <expression>if (Turbidity_base > 0) then Turbidity_base else -11.0</expression>
          <description>Turbidity by Nechad et al. 2009. Plus correction factor</description>
          <type>float32</type>
          <noDataValue>NaN</noDataValue>
        </targetBand>
        <targetBand>
          <name>N</name>
          <type>float32</type>
          <expression>-B*bw_560+B*(aw_560/f)*mrrs_560+alfa*B*(mrrs_560/mrrs_490)*bw_490-alfa*B*(mrrs_560/f)*aw_490</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
        <targetBand>
          <name>D</name>
          <type>float32</type>
          <expression>1-alfa*B*(mrrs_560/mrrs_490)</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
      <variables>
        <variable>
            <name>B</name>
            <type>float32</type>
            <value>1.003</value>
        </variable>
        <variable>
            <name>f</name>
            <type>float32</type>
            <value>0.335</value>
        </variable>
        <variable>
            <name>alfa</name>
            <type>float32</type>
            <value>0.323</value>
        </variable>
        <variable>
            <name>bw_490</name>
            <type>float32</type>
            <value>0.0030</value>
        </variable>
        <variable>
            <name>bw_560</name>
            <type>float32</type>
            <value>0.0013</value>
        </variable>
        <variable>
            <name>aw_490</name>
            <type>float32</type>
            <value>0.0185</value>
        </variable>
        <variable>
            <name>aw_560</name>
            <type>float32</type>
            <value>0.0715</value>
        </variable>
      </variables>
    </parameters>
  </node>
  <node id="BandMaths(3)">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="BandMaths(2)"/>
	  <sourceProduct1 refid="PreCalc"/>
	  <sourceProduct2 refid="Rename_Flag"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
        <targetBand>
          <name>ics</name>
          <type>float32</type>
          <expression>$sourceProduct2.Kd_490+((f*(bw_490+(N/D)))/$sourceProduct1.mrrs_490)+(bw_490+(N/D))+bw_490</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
      <variables>
        <variable>
            <name>f</name>
            <type>float32</type>
            <value>0.335</value>
        </variable>
        <variable>
            <name>bw_490</name>
            <type>float32</type>
            <value>0.0030</value>
        </variable>
      </variables>
    </parameters>
  </node>
  <node id="BandMaths(4)">
    <operator>BandMaths</operator>
    <sources>
      <sourceProduct refid="BandMaths(3)"/>
	  <sourceProduct1 refid="Rename_Flag"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
        <targetBand>
          <name>WaterTransparency</name>
          <type>float32</type>
          <expression>6/(0.0989*ics*ics+0.8879*ics-0.0467)*SDD_scale+SDD_offset</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
      <variables>
        <variable>
            <name>SDD_scale</name>
            <type>float32</type>
            <value>0.23</value>
        </variable>
        <variable>
            <name>SDD_offset</name>
            <type>float32</type>
            <value>1.8</value>
        </variable>
      </variables>
    </parameters>
  </node>
  <node id="BandMath_WT">
    <operator>BandMaths</operator>
    <sources>
	  <sourceProduct1 refid="BandMaths(4)"/>
	  <sourceProduct4 refid="Reproject_seamask"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
        <targetBand>
          <name>WaterTransp</name>
          <type>float32</type>
          <expression>if ($sourceProduct4.band_1) == 0 then -10.0 else (if ($sourceProduct1.WaterTransparency >0) then $sourceProduct1.WaterTransparency else -11.0)</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="BandMath_Tur">
    <operator>BandMaths</operator>
    <sources>
	  <sourceProduct3 refid="BandMaths(2)"/>
	  <sourceProduct4 refid="Reproject_seamask"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <targetBands>
		<targetBand>
          <name>Turbidity</name>
          <type>float32</type>
          <expression>if ($sourceProduct4.band_1) == 0 then -10.0 else (if ($sourceProduct3.Turbidity >0) then $sourceProduct3.Turbidity else -11.0)</expression>
          <description/>
          <unit/>
          <noDataValue>NaN</noDataValue>
        </targetBand>
      </targetBands>
    </parameters>
  </node>
  <node id="Write">
    <operator>Write</operator>
    <sources>
      <sourceProduct refid="BandMath_WT"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$fileoutWT</file>
      <formatName>$format</formatName>
    </parameters>
  </node>
  <node id="Write">
    <operator>Write</operator>
    <sources>
      <sourceProduct refid="BandMath_Tur"/>
    </sources>
    <parameters class="com.bc.ceres.binding.dom.XppDomElement">
      <file>$fileoutTur</file>
      <formatName>$format</formatName>
    </parameters>
  </node>
</graph>